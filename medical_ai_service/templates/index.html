<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Medical AI Assistant - Federated Learning Demo</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      .hero-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 4rem 0;
      }
      .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
      }
      .upload-area:hover {
        border-color: #667eea;
        background-color: #f8f9fa;
      }
      .upload-area.dragover {
        border-color: #667eea;
        background-color: #e3f2fd;
      }
      .result-card {
        border-left: 4px solid #28a745;
        background-color: #f8f9fa;
      }
      .confidence-bar {
        height: 20px;
        background: linear-gradient(
          90deg,
          #dc3545 0%,
          #ffc107 50%,
          #28a745 100%
        );
        border-radius: 10px;
        position: relative;
      }
      .confidence-fill {
        height: 100%;
        background-color: #28a745;
        border-radius: 10px;
        transition: width 0.5s ease;
      }
      .dataset-card {
        transition: transform 0.2s ease;
      }
      .dataset-card:hover {
        transform: translateY(-5px);
      }
      .loading {
        display: none;
      }
      .spinner-border-sm {
        width: 1rem;
        height: 1rem;
      }
    </style>
  </head>
  <body>
    <!-- Hero Section -->
    <div class="hero-section">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 mx-auto text-center">
            <h1 class="display-4 fw-bold mb-4">
              <i class="fas fa-brain me-3"></i>Medical AI Assistant
            </h1>
            <p class="lead mb-4">
              Powered by Federated Learning - Privacy-preserving medical image
              classification
            </p>
            <p class="mb-0">
              Upload medical images for AI-powered diagnosis assistance across
              multiple medical domains
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="container my-5">
      <!-- Dataset Selection -->
      <div class="row mb-5">
        <div class="col-12">
          <h2 class="text-center mb-4">Choose Medical Domain</h2>
          <div class="row" id="dataset-cards">
            <!-- Dataset cards will be populated by JavaScript -->
          </div>
        </div>
      </div>

      <!-- Upload Section -->
      <div class="row">
        <div class="col-lg-8 mx-auto">
          <div class="card shadow">
            <div class="card-header bg-primary text-white">
              <h4 class="mb-0">
                <i class="fas fa-upload me-2"></i>Upload Medical Image
              </h4>
            </div>
            <div class="card-body">
              <form id="uploadForm" enctype="multipart/form-data">
                <input
                  type="hidden"
                  id="selectedDataset"
                  name="dataset"
                  value="pathmnist"
                />

                <div class="upload-area" id="uploadArea">
                  <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                  <h5>Drag & Drop Image Here</h5>
                  <p class="text-muted">or click to browse</p>
                  <input
                    type="file"
                    id="imageInput"
                    name="image"
                    accept="image/*"
                    style="display: none"
                  />
                </div>

                <div class="mt-3">
                  <button
                    type="submit"
                    class="btn btn-primary btn-lg w-100"
                    id="classifyBtn"
                  >
                    <i class="fas fa-search me-2"></i>Classify Image
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Results Section -->
      <div class="row mt-5" id="resultsSection" style="display: none">
        <div class="col-lg-8 mx-auto">
          <div class="card result-card">
            <div class="card-header">
              <h4 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>Classification Results
              </h4>
            </div>
            <div class="card-body">
              <div id="resultsContent">
                <!-- Results will be populated here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading Section -->
      <div class="row mt-5 loading" id="loadingSection">
        <div class="col-lg-8 mx-auto text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Analyzing image with AI...</p>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <h5>Medical AI Assistant</h5>
            <p class="mb-0">Powered by Federated Learning</p>
          </div>
          <div class="col-md-6 text-md-end">
            <p class="mb-0">
              <i class="fas fa-shield-alt me-2"></i>
              Privacy-preserving AI for medical diagnosis
            </p>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Global variables
      let selectedDataset = "pathmnist";
      let datasets = {};

      // Load datasets on page load
      async function loadDatasets() {
        try {
          const response = await fetch("/api/datasets");
          datasets = await response.json();
          renderDatasetCards();
        } catch (error) {
          console.error("Error loading datasets:", error);
        }
      }

      // Render dataset selection cards
      function renderDatasetCards() {
        const container = document.getElementById("dataset-cards");
        container.innerHTML = "";

        Object.entries(datasets).forEach(([key, info]) => {
          const card = document.createElement("div");
          card.className = "col-md-6 col-lg-4 mb-3";
          card.innerHTML = `
                    <div class="card dataset-card h-100 ${
                      key === selectedDataset ? "border-primary" : ""
                    }" 
                         data-dataset="${key}" onclick="selectDataset('${key}')">
                        <div class="card-body text-center">
                            <i class="fas fa-${getDatasetIcon(
                              key
                            )} fa-2x text-primary mb-3"></i>
                            <h5 class="card-title">${info.name}</h5>
                            <p class="card-text small text-muted">${
                              info.description
                            }</p>
                            <small class="text-muted">${
                              info.classes.length
                            } classes</small>
                        </div>
                    </div>
                `;
          container.appendChild(card);
        });
      }

      // Get icon for dataset
      function getDatasetIcon(dataset) {
        const icons = {
          pathmnist: "lungs",
          dermamnist: "hand-paper",
          retinamnist: "eye",
          bloodmnist: "tint",
          organamnist: "heart",
        };
        return icons[dataset] || "image";
      }

      // Select dataset
      function selectDataset(dataset) {
        selectedDataset = dataset;
        document.getElementById("selectedDataset").value = dataset;

        // Update UI
        document.querySelectorAll(".dataset-card").forEach((card) => {
          card.classList.remove("border-primary");
        });
        document
          .querySelector(`[data-dataset="${dataset}"]`)
          .classList.add("border-primary");
      }

      // Upload area interactions
      const uploadArea = document.getElementById("uploadArea");
      const imageInput = document.getElementById("imageInput");

      uploadArea.addEventListener("click", () => imageInput.click());
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });
      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });
      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          imageInput.files = files;
          updateUploadArea(files[0]);
        }
      });

      imageInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) {
          updateUploadArea(e.target.files[0]);
        }
      });

      function updateUploadArea(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          uploadArea.innerHTML = `
                    <img src="${e.target.result}" class="img-fluid mb-3" style="max-height: 200px;">
                    <h6>${file.name}</h6>
                    <p class="text-muted">Click to change image</p>
                `;
        };
        reader.readAsDataURL(file);
      }

      // Form submission
      document
        .getElementById("uploadForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData();
          const imageFile = document.getElementById("imageInput").files[0];

          if (!imageFile) {
            alert("Please select an image first");
            return;
          }

          formData.append("image", imageFile);
          formData.append("dataset", selectedDataset);

          // Show loading
          document.getElementById("loadingSection").style.display = "block";
          document.getElementById("resultsSection").style.display = "none";
          document.getElementById("classifyBtn").disabled = true;

          try {
            const response = await fetch("/classify", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();
            displayResults(result);
          } catch (error) {
            console.error("Error:", error);
            alert("Classification failed. Please try again.");
          } finally {
            document.getElementById("loadingSection").style.display = "none";
            document.getElementById("classifyBtn").disabled = false;
          }
        });

      function displayResults(result) {
        if (result.error) {
          document.getElementById("resultsContent").innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${result.error}
                    </div>
                `;
        } else {
          const datasetInfo = datasets[selectedDataset];
          const confidencePercent = Math.round(result.confidence * 100);

          document.getElementById("resultsContent").innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Prediction</h5>
                            <div class="alert alert-success">
                                <strong>${result.predicted_class}</strong>
                                <div class="mt-2">
                                    <div class="confidence-bar">
                                        <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                                    </div>
                                    <small class="text-muted">${confidencePercent}% confidence</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Top Predictions</h5>
                            <ul class="list-group list-group-flush">
                                ${result.top_predictions
                                  .map(
                                    (pred, index) => `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        ${pred.class}
                                        <span class="badge bg-primary rounded-pill">
                                            ${Math.round(
                                              pred.probability * 100
                                            )}%
                                        </span>
                                    </li>
                                `
                                  )
                                  .join("")}
                            </ul>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            This is an AI-assisted diagnosis tool. Always consult with medical professionals for final diagnosis.
                        </small>
                    </div>
                `;
        }

        document.getElementById("resultsSection").style.display = "block";
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", loadDatasets);
    </script>
  </body>
</html>
